7:from collections import defaultdict, deque
33:def load_anti_chop_model():
43:def is_valid_dataframe(df, min_rows: int = 1) -> bool:
69:def get_polygon_rates_fallback(symbol: str, timeframe, count: int) -> Optional[pd.DataFrame]:
146:def safe_copy_rates(symbol: str, timeframe, count: int = 500, timeout: int = 12) -> Optional[pd.DataFrame]:
163:    def worker():
197:def lambda_invoke(function_name: str, payload: dict) -> Optional[dict]:
222:def cached_symbol_info(symbol: str) -> Optional[mt5.SymbolInfo]:
243:def cached_symbol_info_tick(symbol: str):
273:def check_anti_overtrading(symbol: str, max_trades_per_hour: int = 3, 
316:def register_trade_for_overtrading(symbol: str):
330:def get_realtime_win_rate(lookback_trades: int = 20) -> Dict[str, float]:
354:            return _default_win_rate_result()
360:            return _default_win_rate_result()
386:        return _default_win_rate_result()
389:def _default_win_rate_result() -> Dict[str, float]:
403:def get_symbol_performance(symbol: str, lookback_days: int = 30) -> Dict[str, float]:
438:def get_dynamic_rr_min() -> float:
510:def get_vix_br() -> float:
543:def get_order_flow(symbol: str, bars: int = 20) -> Dict[str, float]:
592:def get_real_slippage(symbol: str) -> float:
611:def check_and_alert_slippage(symbol: str, requested_price: float, 
677:def detect_market_regime() -> str:
693:def calculate_sector_exposure_pct(equity: float) -> Dict[str, float]:
697:    sector_risk = defaultdict(float)
704:def get_ibov_correlation(symbol: str, lookback: int = 50) -> float:
734:def validate_subsetor_exposure(symbol: str) -> Tuple[bool, str]:
770:def get_book_imbalance(symbol: str) -> float:
805:def get_book_imbalance(symbol: str) -> float:
827:def get_daily_max_equity() -> float:
848:def get_fast_rates(symbol, timeframe):
865:def get_atr(df: pd.DataFrame, period: int = 14) -> Optional[float]:
875:def get_adx(df: pd.DataFrame, period: int = 14) -> Optional[float]:
899:def get_intraday_vwap(df: pd.DataFrame) -> Optional[float]:
922:def get_obv(df: pd.DataFrame) -> Optional[float]:
963:def is_obv_trending_up(df: pd.DataFrame, lookback: int = 20) -> bool:
1006:def macro_trend_ok(symbol: str, side: str) -> bool:
1029:def get_momentum(df: pd.DataFrame, period: int = 10) -> Optional[float]:
1053:def quick_indicators_custom(symbol, timeframe, df=None, params=None):
1170:def check_volatility_filter(symbol: str, atr: float, current_price: float) -> tuple[bool, str]:
1236:def calculate_daily_dd() -> float:
1262:def calculate_signal_score(ind: dict) -> float:
1360:def check_arbitrage_opp(sym1: str, sym2: str) -> bool:
1375:def check_and_close_orphans(active_signals: dict):
1385:def get_avg_volume(df, window: int = 20):
1398:def resolve_signal_weights(symbol, sector, base_weights,
1412:def update_symbol_weights(symbol, sector, score_log, trade_result):
1427:def get_telegram_bot():
1441:def send_telegram_exit(symbol: str, side: str = "", volume: float = 0, entry_price: float = 0, exit_price: float = 0, profit_loss: float = 0, reason: str = ""):
1480:def close_position(symbol: str, ticket: int, volume: float, price: float, reason: str = "SaÃ­da EstratÃ©gica"):
1548:def save_adaptive_weights():
1569:def load_adaptive_weights():
1604:def check_liquidity(symbol: str, threshold_pct: float = 0.7) -> bool:
1653:def calculate_position_size_atr(symbol: str, price: float, atr_dist: float, risk_money: float = None) -> float:
1693:def signal_handler(sig, frame):
1706:def send_telegram_trade(symbol: str, side: str, volume: float, price: float, sl: float, tp: float, comment: str = ""):
1748:def validate_mt5_connection():
1772:def send_order_with_sl_tp(symbol, side, volume, sl, tp, comment="XP3_BOT"):
1859:def send_order_with_retry(symbol, side, volume, sl, tp, max_retries=3):
1882:def validate_order_params(symbol: str, volume: float, price: float, sl: float, tp: float) -> bool:
1909:def get_time_bucket():
1918:def is_power_hour():
1927:def is_volatility_breakout(df, atr_now, atr_mean, volume_ratio, side=None):
1956:def get_current_risk_pct() -> float:
2005:def get_dynamic_slippage(symbol, hour):
2019:def update_adaptive_weights():
2037:def calculate_smart_sl(symbol, entry_price, side, atr, df):
2079:def analyze_order_book_depth(symbol, side, volume_needed):
2140:def apply_trailing_stop(symbol: str, side: str, current_price: float, atr: float):
2191:            # This block is inserted based on the user's instruction, assuming 'label' and 'utils' are defined elsewhere.
2193:            # Note: 'label' is not defined in this function's scope in the provided content.
2194:            # This insertion might lead to a NameError if 'label' is not globally or locally defined.
2246:def apply_trailing_stop_deprecated(symbol: str, side: str, current_price: float, atr: float):
2340:def can_enter_symbol(symbol: str, equity: float) -> bool:
2367:def calculate_correlation_matrix(symbols: List[str], lookback: int = 60) -> Dict[str, Dict[str, float]]:
2415:_symbol_loss_streak = defaultdict(int)
2419:def load_loss_streak_data():
2425:                _symbol_loss_streak = defaultdict(int, data.get("streak", {}))
2432:def save_loss_streak_data():
2445:def record_trade_outcome(symbol: str, profit_loss: float):
2472:def is_symbol_blocked(symbol: str) -> tuple[bool, str]:
2492:def get_cached_indicators(symbol: str, timeframe, count: int = 300, ttl: int = 45):
2527:def mt5_with_retry(max_retries: int = 4, base_delay: float = 1.0):
2531:    def decorator(func):
2532:        def wrapper(*args, **kwargs):
2539:                        logger.error(f"ğŸš¨ Falha definitiva em {func.__name__} apÃ³s {max_retries} tentativas: {e}")
2548:def calculate_advanced_metrics(trades_df: pd.DataFrame) -> Dict[str, float]:
2577:def get_realtime_win_rate(lookback_trades: int = 20) -> Dict[str, Any]:
2630:def is_spread_acceptable(symbol, max_spread_pct=None):
2663:def adjust_global_sl_after_pyr(symbol, side, current_price, atr):
2700:def apply_anti_martingale(loss_streak: int) -> float:
2707:def calculate_dynamic_sl_tp(symbol, side, entry_price, ind):
2738:def normalize_price(symbol, price):
2746:def check_and_apply_breakeven(symbol, current_indicators, move_threshold_atr=1.0):
2773:def modify_sl_tp(ticket, new_sl, new_tp):
2801:def update_correlations(top15_symbols):
2841:def send_telegram_message(text: str):
2857:def send_daily_performance_report():
2894:def send_news_alert(message: str):
2909:def send_next_high_impact_event():
2920:def send_current_blackout_status():
2940:def mt5_crash_recovery():
2949:def get_daily_volume() -> float:
2960:def calculate_daily_dd() -> float:
